<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realizar Venta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
    <div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-xl w-full">
        <h1 class="text-3xl font-bold text-green-700 mb-6 text-center">Realizar Nueva Venta</h1>

        <div class="mb-6">
            <label for="barcodeInput" class="block text-gray-700 text-sm font-bold mb-2">
                Escanear Código de Barras:
            </label>
            <input type="text" id="barcodeInput" autofocus 
                   class="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-green-500"
                   placeholder="Escanear producto...">
            <p class="text-sm text-gray-500 mt-1">El lector de código de barras actuará como un teclado.</p>
        </div>

        <div id="productInfo" class="hidden bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-md mb-6">
            <h3 class="text-lg font-semibold mb-2">Producto Escaneado:</h3>
            <p><strong>Nombre:</strong> <span id="scannedProductName"></span></p>
            <p><strong>Precio:</strong> S/ <span id="scannedProductPrice"></span></p>
            <p><strong>Stock Disponible:</strong> <span id="scannedProductStock"></span></p>
            <div class="mt-4 flex items-center space-x-4">
                <label for="quantityInput" class="block text-gray-700 text-sm font-bold">Cantidad:</label>
                <input type="number" id="quantityInput" value="1" min="1"
                       class="shadow appearance-none border rounded-md py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline w-20">
                <button id="addProductBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                    Añadir al Carrito
                </button>
            </div>
        </div>

        <div id="cart" class="mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Productos en el Carrito:</h3>
            <ul id="cartList" class="border border-gray-200 rounded-md divide-y divide-gray-200">
                <!-- Los productos se añadirán aquí dinámicamente -->
            </ul>
            <p id="emptyCartMessage" class="text-gray-600 text-center py-4">El carrito está vacío.</p>
        </div>

        <div class="flex justify-between items-center mb-6 border-t border-gray-300 pt-4">
            <span class="text-2xl font-bold text-gray-900">Total:</span>
            <span id="cartTotal" class="text-3xl font-extrabold text-green-700">S/ 0.00</span>
        </div>

        <button id="completeSaleBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            Completar Venta
        </button>

        <div id="messageBox" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                <p id="messageText" class="text-lg font-semibold mb-4"></p>
                <button id="closeMessageBox" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md">Cerrar</button>
            </div>
        </div>

        <div class="mt-8 text-center">
            <a href="{% url 'home' %}" class="inline-block bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-5 rounded-md transition duration-300 ease-in-out">
                Volver al Inicio
            </a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const barcodeInput = document.getElementById('barcodeInput');
            const productInfoDiv = document.getElementById('productInfo');
            const scannedProductName = document.getElementById('scannedProductName');
            const scannedProductPrice = document.getElementById('scannedProductPrice');
            const scannedProductStock = document.getElementById('scannedProductStock');
            const quantityInput = document.getElementById('quantityInput');
            const addProductBtn = document.getElementById('addProductBtn');
            const cartList = document.getElementById('cartList');
            const cartTotal = document.getElementById('cartTotal');
            const completeSaleBtn = document.getElementById('completeSaleBtn');
            const emptyCartMessage = document.getElementById('emptyCartMessage');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const closeMessageBox = document.getElementById('closeMessageBox');

            let currentCart = []; // Almacenará los productos en el carrito
            let scannedProduct = null; // Almacena el producto actualmente escaneado

            // Función para mostrar mensajes en un cuadro de diálogo personalizado
            function showMessage(message) {
                messageText.textContent = message;
                messageBox.classList.remove('hidden');
            }

            closeMessageBox.addEventListener('click', function() {
                messageBox.classList.add('hidden');
            });

            // Función para actualizar el carrito en la interfaz de usuario
            function updateCartUI() {
                cartList.innerHTML = ''; // Limpiar la lista actual
                let total = 0;

                if (currentCart.length === 0) {
                    emptyCartMessage.classList.remove('hidden');
                    completeSaleBtn.disabled = true;
                } else {
                    emptyCartMessage.classList.add('hidden');
                    completeSaleBtn.disabled = false;
                }

                currentCart.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center p-4 hover:bg-gray-50';
                    listItem.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-600">Cantidad: ${item.quantity} x S/ ${item.price.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-lg text-green-600">S/ ${(item.quantity * item.price).toFixed(2)}</span>
                            <button data-product-id="${item.id}" class="remove-item-btn bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded-md">Quitar</button>
                        </div>
                    `;
                    cartList.appendChild(listItem);
                    total += item.quantity * item.price;
                });

                cartTotal.textContent = `S/ ${total.toFixed(2)}`;
            }

            // Event listener para el input del código de barras
            barcodeInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Evitar el envío del formulario si existe
                    const barcode = barcodeInput.value.trim();
                    if (barcode) {
                        fetch('/sales/add_product/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}' // Necesitas esto si no usas @csrf_exempt
                            },
                            body: JSON.stringify({ barcode: barcode })
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw new Error(err.message || 'Error al buscar producto'); });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                scannedProduct = data.product;
                                scannedProductName.textContent = scannedProduct.name;
                                scannedProductPrice.textContent = scannedProduct.price.toFixed(2);
                                scannedProductStock.textContent = scannedProduct.stock;
                                quantityInput.value = 1; // Resetear cantidad
                                productInfoDiv.classList.remove('hidden');
                                barcodeInput.value = ''; // Limpiar input
                                barcodeInput.focus(); // Volver a enfocar para el siguiente escaneo
                            } else {
                                showMessage(data.message || 'Producto no encontrado.');
                                productInfoDiv.classList.add('hidden');
                                scannedProduct = null;
                            }
                        })
                        .catch(error => {
                            showMessage(`Error: ${error.message}`);
                            productInfoDiv.classList.add('hidden');
                            scannedProduct = null;
                        });
                    }
                }
            });

            // Event listener para añadir producto al carrito
            addProductBtn.addEventListener('click', function() {
                if (scannedProduct) {
                    const quantity = parseInt(quantityInput.value);
                    if (isNaN(quantity) || quantity <= 0) {
                        showMessage('La cantidad debe ser un número positivo.');
                        return;
                    }
                    if (quantity > scannedProduct.stock) {
                        showMessage(`No hay suficiente stock. Solo quedan ${scannedProduct.stock} unidades.`);
                        return;
                    }

                    const existingItemIndex = currentCart.findIndex(item => item.id === scannedProduct.id);

                    if (existingItemIndex > -1) {
                        // Si el producto ya está en el carrito, actualizar cantidad
                        const newQuantity = currentCart[existingItemIndex].quantity + quantity;
                        if (newQuantity > scannedProduct.stock) {
                             showMessage(`No puedes añadir más. El stock es ${scannedProduct.stock}.`);
                             return;
                        }
                        currentCart[existingItemIndex].quantity = newQuantity;
                    } else {
                        // Si es un producto nuevo, añadirlo
                        currentCart.push({
                            id: scannedProduct.id,
                            name: scannedProduct.name,
                            price: scannedProduct.price,
                            quantity: quantity
                        });
                    }
                    
                    updateCartUI();
                    productInfoDiv.classList.add('hidden'); // Ocultar info de producto escaneado
                    scannedProduct = null; // Limpiar producto escaneado
                    barcodeInput.focus(); // Volver a enfocar para el siguiente escaneo
                } else {
                    showMessage('Primero escanea un producto.');
                }
            });

            // Event listener para quitar productos del carrito
            cartList.addEventListener('click', function(event) {
                if (event.target.classList.contains('remove-item-btn')) {
                    const productIdToRemove = parseInt(event.target.dataset.productId);
                    currentCart = currentCart.filter(item => item.id !== productIdToRemove);
                    updateCartUI();
                }
            });

            // Event listener para completar la venta
            completeSaleBtn.addEventListener('click', function() {
                if (currentCart.length === 0) {
                    showMessage('El carrito está vacío. Añade productos para completar la venta.');
                    return;
                }

                // Enviar los datos del carrito al backend para registrar la venta
                fetch('/sales/complete_sale/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}' // Necesitas esto para POST requests en Django
                    },
                    body: JSON.stringify({ cart: currentCart })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'Error al completar la venta'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showMessage(data.message);
                        currentCart = []; // Vaciar carrito
                        updateCartUI();
                        // Opcional: recargar la página o redirigir
                        // setTimeout(() => window.location.reload(), 2000); 
                    } else {
                        showMessage(data.message || 'Hubo un problema al completar la venta.');
                    }
                })
                .catch(error => {
                    showMessage(`Error: ${error.message}`);
                });
            });

            // Asegurarse de que el input de código de barras tenga el foco al cargar la página
            barcodeInput.focus();
        });
    </script>
</body>
</html>


